{% extends 'base.html' %}

{% block content%}
<table id="itemlist" class="display" style="width:100%">
        <thead>
            <tr>
                <th>Item</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Retailer</th>
                <th>Must Get</th>
                <th>Action</th>
                <th>Listed</th>               
            </tr>
        </thead>
        <tbody>
            {% for item in items.all %}
                <tr>
                <td>{{ item.item}}</td>
                <td>{{ item.price}}</td>
                <td>{{ item.qty}}</td>
                <td>{{ item.retailer.retailer}}</td>
                {% if item.mustget == 1 %}
                <td>Yes</td>
                {% else %}
                <td>No</td>
                {% endif%}
                {% if item.current == 1 %}
                <td><span><button type="button" class="btn btn-outline-danger btn-sm btn-block additemtolist" itemid="{{ item.id}}">Remove Item</button></span></td>
                <td><div id="listed_{{item.id}}"><strong>Yes</strong></div></td>
                {% else %}
                <td><span><button type="button" class="btn btn-outline-primary btn-sm btn-block additemtolist" itemid="{{ item.id}}">Add to List</button></span></td>
                <td><div id="listed_{{item.id}}"></div></td>
                {% endif %}
                
                </tr>
            {% endfor%}
        </tbody>
    </table>
    {%csrf_token%}
{% endblock%}

{% block script%}
<script>
$('#itemlist').DataTable();
$('.additemtolist').on('click',function(e){
    var tCurrentState = $(this).html();
    console.log(tCurrentState)
    if(tCurrentState=='Remove Item'){
        tCurrentState = 'Remove'
    }else{
        tCurrentState = 'Add'
    }
    console.log(tCurrentState)
    e.preventDefault();
    console.log('Adding item to current list')
    var tID = $(this).attr('itemid');
    $.ajax({
        method: 'POST',
        url: 'addItemToListHandler',
        data: {
            id: tID,
            state: tCurrentState,
            csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
        },
        success:function(result){
            console.log(result)
            if(result==1){
                if(tCurrentState=='Remove'){
                    $('[itemid='+tID+']').html('Add Item')
                    $('[itemid='+tID+']').removeClass('btn-outline-danger')
                    $('[itemid='+tID+']').addClass('btn-outline-primary')
                    $('#listed_'+tID+'').empty();
                }else{
                    $('[itemid='+tID+']').html('Remove Item')
                    $('[itemid='+tID+']').removeClass('btn-outline-primary')
                    $('[itemid='+tID+']').addClass('btn-outline-danger')
                    $('#listed_'+tID+'').empty().append('<strong>Yes</strong>');
                }
                
               
            }else{
                alert('Failed to add item to list')
            }
        },
        error:function(result){

        }
        
    })
})
</script>
{% endblock%}